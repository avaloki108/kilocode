// kilocode_change - new file

/**
 * Vulnerability Viewer Component
 * 
 * This component displays detailed vulnerability information including
 * code snippets, severity indicators, and remediation guidance.
 * 
 * @see WEB3-SECURITY-PLATFORM-ARCHITECTURE.md
 */

import React, { useState } from "react"
import { VSCodeButton } from "@vscode/webview-ui-toolkit/react"
import type { Vulnerability } from "../../../../packages/core-schemas/src/web3-security/vulnerability.js"

/**
 * Vulnerability viewer props
 */
interface VulnerabilityViewerProps {
	/** Vulnerability to display */
	vulnerability: Vulnerability
	/** On dismiss callback */
	onDismiss?: () => void
	/** On fix callback */
	onFix?: () => void
	/** On view code callback */
	onViewCode?: () => void
	/** Show code snippets by default */
	showCode?: boolean
}

/**
 * Vulnerability Viewer Component
 */
export const VulnerabilityViewer: React.FC<VulnerabilityViewerProps> = ({
	vulnerability,
	onDismiss,
	onFix,
	onViewCode,
	showCode = true,
}) => {
	const [expanded, setExpanded] = useState(false)
	const [showFullDescription, setShowFullDescription] = useState(false)

	// Get severity color
	const getSeverityColor = (severity: string): string => {
		switch (severity) {
			case "critical":
				return "text-red-500"
			case "high":
				return "text-orange-500"
			case "medium":
				return "text-yellow-500"
			case "low":
				return "text-blue-500"
			default:
				return "text-gray-500"
		}
	}

	// Get severity icon
	const getSeverityIcon = (severity: string): string => {
		switch (severity) {
			case "critical":
				return "ðŸ”´"
			case "high":
				return "ðŸŸ "
			case "medium":
				return "ðŸŸ¡"
			case "low":
				return "ðŸŸ¢"
			default:
				return "â„¹ï¸"
		}
	}

	// Get severity badge class
	const getSeverityBadgeClass = (severity: string): string => {
		const baseClass = "px-3 py-1 text-xs font-semibold rounded-full"
		return `${baseClass} ${getSeverityColor(severity)}`
	}

	return (
		<div className="bg-vscode-editor-background rounded-lg p-4 border border-vscode-widget-border">
			{/* Header */}
			<div className="flex items-start justify-between mb-3">
				<div className="flex items-center gap-2">
					<span className="text-2xl">{getSeverityIcon(vulnerability.severity)}</span>
					<div>
						<h3 className="text-lg font-semibold text-vscode-foreground">
							{vulnerability.title}
						</h3>
						<div className={`text-sm px-2 py-1 rounded-full ${getSeverityBadgeClass(
							vulnerability.severity,
						)}`}>
							{vulnerability.severity.toUpperCase()}
						</div>
					</div>
				</div>
				<div className="flex gap-2">
					{onDismiss && (
						<VSCodeButton appearance="secondary" size="small" onClick={onDismiss}>
							Dismiss
						</VSCodeButton>
					)}
					{onFix && (
						<VSCodeButton appearance="primary" size="small" onClick={onFix}>
							Fix
						</VSCodeButton>
					)}
				</div>
			</div>

			{/* Category and Source */}
			<div className="flex gap-4 mb-3">
				<div className="flex-1">
					<span className="text-sm text-vscode-descriptionForeground">Category:</span>
					<span className="text-sm font-medium text-vscode-foreground">
						{vulnerability.category}
					</span>
				</div>
				<div className="flex-1">
					<span className="text-sm text-vscode-descriptionForeground">Source:</span>
					<span className="text-sm font-medium text-vscode-foreground">
						{vulnerability.source}
					</span>
				</div>
				<div className="flex-1">
					<span className="text-sm text-vscode-descriptionForeground">Chain:</span>
					<span className="text-sm font-medium text-vscode-foreground">
						{vulnerability.chain}
					</span>
				</div>
			</div>

			{/* Description */}
			<div className="mb-4">
				<div className="flex items-center justify-between mb-2">
					<h4 className="text-base font-semibold text-vscode-foreground">
						Description
					</h4>
					<button
						className="text-sm text-blue-400 hover:text-blue-300"
						onClick={() => setShowFullDescription(!showFullDescription)}
					>
						{showFullDescription ? "Show Less" : "Show More"}
					</button>
				</div>
				<p className="text-sm text-vscode-descriptionForeground">
					{showFullDescription
						? vulnerability.description
						: vulnerability.description.length > 200
						? `${vulnerability.description.substring(0, 200)}...`
						: vulnerability.description}
				</p>
			</div>

			{/* Location */}
			{vulnerability.location && (
				<div className="mb-4">
					<h4 className="text-base font-semibold text-vscode-foreground mb-2">
						Location
					</h4>
					<div className="bg-vscode-editor-background rounded-md p-3 border border-vscode-widget-border">
						<div className="flex items-center gap-2 mb-2">
							<div className="flex-1">
								<span className="text-sm text-vscode-descriptionForeground">
									File:
								</span>
								<span className="text-sm font-medium text-vscode-foreground">
									{vulnerability.location.file}
								</span>
							</div>
							<div className="flex-1">
								<span className="text-sm text-vscode-descriptionForeground">
									Line:
								</span>
								<span className="text-sm font-medium text-vscode-foreground">
									{vulnerability.location.line}
								</span>
							</div>
						</div>
						{vulnerability.location.codeSnippet && (
							<div className="mt-3">
								<div className="flex items-center justify-between mb-2">
									<span className="text-sm text-vscode-descriptionForeground">
										Code Snippet:
									</span>
									{onViewCode && (
										<VSCodeButton appearance="secondary" size="small" onClick={onViewCode}>
											View Code
										</VSCodeButton>
									)}
								</div>
								<div className="bg-vscode-editor-background rounded-md p-3 border border-vscode-widget-border overflow-x-auto">
									<pre className="text-xs text-vscode-foreground whitespace-pre-wrap break-all">
										<code>{vulnerability.location.codeSnippet}</code>
									</pre>
								</div>
							</div>
						)}
					</div>
				</div>
			)}

			{/* Remediation */}
			{vulnerability.remediation && (
				<div className="mb-4">
					<h4 className="text-base font-semibold text-vscode-foreground mb-2">
						Remediation
					</h4>
					<div className="bg-vscode-editor-background rounded-md p-3 border border-vscode-widget-border">
						<p className="text-sm text-vscode-descriptionForeground mb-2">
							{vulnerability.remediation}
						</p>
						{vulnerability.remediationCode && (
							<div className="mt-3">
								<div className="flex items-center justify-between mb-2">
									<span className="text-sm text-vscode-descriptionForeground">
										Remediation Code:
									</span>
									{onViewCode && (
										<VSCodeButton appearance="secondary" size="small" onClick={onViewCode}>
											View Code
										</VSCodeButton>
									)}
								</div>
								<div className="bg-vscode-editor-background rounded-md p-3 border border-vscode-widget-border overflow-x-auto">
									<pre className="text-xs text-vscode-foreground whitespace-pre-wrap break-all">
										<code>{vulnerability.remediationCode}</code>
									</pre>
								</div>
							</div>
						)}
					</div>
				</div>
			)}

			{/* Impact */}
			{vulnerability.impact && (
				<div className="mb-4">
					<h4 className="text-base font-semibold text-vscode-foreground mb-2">
						Impact
					</h4>
					<div className="bg-vscode-editor-background rounded-md p-3 border border-vscode-widget-border">
						<p className="text-sm text-vscode-descriptionForeground">
							{vulnerability.impact}
						</p>
					</div>
				</div>
			)}

			{/* References */}
			{vulnerability.references && vulnerability.references.length > 0 && (
				<div className="mb-4">
					<h4 className="text-base font-semibold text-vscode-foreground mb-2">
						References
					</h4>
					<ul className="list-disc list-inside bg-vscode-editor-background rounded-md p-3 border border-vscode-widget-border space-y-2">
						{vulnerability.references.map((ref, index) => (
							<li key={index} className="text-sm">
								<a
									href={ref.url}
									target="_blank"
									rel="noopener noreferrer"
									className="text-blue-400 hover:text-blue-300 hover:underline"
								>
									{ref.title || ref.url}
								</a>
							</li>
						))}
					</ul>
				</div>
			)}

			{/* Expand/Collapse Details */}
			<div className="flex justify-center pt-4">
				<VSCodeButton appearance="secondary" onClick={() => setExpanded(!expanded)}>
					{expanded ? "Show Less" : "Show Details"}
				</VSCodeButton>
			</div>
		</div>
	)
}
